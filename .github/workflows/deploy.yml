# å·¥ä½œæµåç§°
name: Deploy to Cloudflare

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å½“ main åˆ†æ”¯æœ‰ä»£ç æ¨é€æ—¶è§¦å‘
  push:
    branches:
      - main
  # å…è®¸åœ¨ GitHub Actions ç•Œé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šè®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm install

      # ç¬¬å››æ­¥ï¼šæ£€æŸ¥ Cloudflare åŸºç¡€å¯†é’¥
      # ä¼˜å…ˆæ£€æŸ¥è¿æ¥ Cloudflare æ‰€éœ€çš„è®¤è¯ä¿¡æ¯
      - name: Check for Cloudflare credentials
        id: check_cf_creds
        run: |
          if [ -z "${{ secrets.CF_API_TOKEN }}" ] || [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
            # å‘é€å…¨å±€è­¦å‘Š
            echo "::warning::Cloudflare credentials missing (CF_API_TOKEN or CF_ACCOUNT_ID). Deployment skipped."
            
            # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šåˆ° Summary
            echo "## ğŸ›‘ éƒ¨ç½²å·²è·³è¿‡ (Deployment Skipped)" >> $GITHUB_STEP_SUMMARY
            echo "æ£€æµ‹åˆ°ç¼ºå°‘ Cloudflare è®¤è¯å¯†é’¥ï¼Œæ— æ³•è¿›è¡Œéƒ¨ç½²ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Secret Name | Status | Required |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
            
            if [ -z "${{ secrets.CF_API_TOKEN }}" ]; then
              echo "| CF_API_TOKEN | âŒ Missing | Yes |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| CF_API_TOKEN | âœ… Found | Yes |" >> $GITHUB_STEP_SUMMARY
            fi
            
            if [ -z "${{ secrets.CF_ACCOUNT_ID }}" ]; then
              echo "| CF_ACCOUNT_ID | âŒ Missing | Yes |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| CF_ACCOUNT_ID | âœ… Found | Yes |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "has_cf_creds=false" >> $GITHUB_ENV
          else
            echo "Cloudflare credentials found."
            echo "has_cf_creds=true" >> $GITHUB_ENV
          fi

      # ç¬¬äº”æ­¥ï¼šæ£€æŸ¥ EPG_URL å˜é‡ (ç‹¬ç«‹ Check)
      # ç‹¬ç«‹æ£€æŸ¥ä¸šåŠ¡å¿…é¡»çš„ EPG_URL å˜é‡ï¼Œåªæœ‰å½“åŸºç¡€å¯†é’¥å­˜åœ¨æ—¶æ‰æœ‰æ„ä¹‰ï¼Œä½†æ­¤å¤„ä½œä¸ºç‹¬ç«‹æ­¥éª¤æ‰§è¡Œ
      - name: Check for EPG_URL
        id: check_epg
        run: |
          if [ -z "${{ secrets.EPG_URL }}" ]; then
            # å‘é€å…¨å±€è­¦å‘Š
            echo "::warning::EPG_URL secret is missing! Deployment will be skipped."
            
            # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Šåˆ° Summary
            echo "## âš ï¸ é…ç½®ç¼ºå¤±è­¦å‘Š (Configuration Warning)" >> $GITHUB_STEP_SUMMARY
            echo "è™½ç„¶ Cloudflare å¯†é’¥å¯èƒ½å­˜åœ¨ï¼Œä½†ç¼ºå°‘æ ¸å¿ƒä¸šåŠ¡å˜é‡ **EPG_URL**ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| å˜é‡å | çŠ¶æ€ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
            echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
            echo "| **EPG_URL** | âŒ ç¼ºå¤± | **å¿…å¡«**ï¼šä¸» EPG æºåœ°å€ |" >> $GITHUB_STEP_SUMMARY
            echo "| EPG_URL_BACKUP | â„¹ï¸ å¯é€‰ | å¤‡ç”¨æºåœ°å€ |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> è¯·å‰å¾€ **Settings -> Secrets and variables -> Actions** æ·»åŠ è¯¥å˜é‡ã€‚" >> $GITHUB_STEP_SUMMARY
            
            echo "has_epg=false" >> $GITHUB_ENV
          else
            echo "EPG_URL found."
            echo "has_epg=true" >> $GITHUB_ENV
          fi

      # ç¬¬å…­æ­¥ï¼šåŠ¨æ€ç”Ÿæˆå¯†é’¥åˆ—è¡¨
      # è¯´æ˜ï¼šä¸ºäº†æ”¯æŒå¯é€‰å˜é‡ï¼Œæˆ‘ä»¬éœ€è¦åŠ¨æ€ç”Ÿæˆä¼ é€’ç»™ wrangler çš„ secrets åˆ—è¡¨
      # å¦‚æœæŸä¸ª secret æœªåœ¨ GitHub è®¾ç½®ï¼Œåˆ™ä¸åº”åŒ…å«åœ¨åˆ—è¡¨ä¸­ï¼Œå¦åˆ™éƒ¨ç½²ä¼šæŠ¥é”™
      - name: Generate Secret List
        id: secret_gen
        # å°† secret æ˜ å°„åˆ° envï¼Œä»¥ä¾¿åœ¨è„šæœ¬ä¸­å®‰å…¨åˆ¤æ–­
        env:
          EPG_URL_BACKUP: ${{ secrets.EPG_URL_BACKUP }}
          CACHE_TTL: ${{ secrets.CACHE_TTL }}
          FETCH_TIMEOUT: ${{ secrets.FETCH_TIMEOUT }}
          MAX_MEMORY_CACHE_CHARS: ${{ secrets.MAX_MEMORY_CACHE_CHARS }}
          MAX_SOURCE_SIZE_BYTES: ${{ secrets.MAX_SOURCE_SIZE_BYTES }}
          ERROR_COOLDOWN_MS: ${{ secrets.ERROR_COOLDOWN_MS }}
        run: |
          # å¼€å§‹æ„å»ºåˆ—è¡¨ï¼ŒEPG_URL æ˜¯å¿…å¡«é¡¹ï¼Œä¸€å®šåŒ…å«
          # ä½¿ç”¨ EOF å—å†™å…¥ GITHUB_OUTPUTï¼Œæ”¯æŒå¤šè¡Œ
          {
            echo "list<<EOF"
            echo "EPG_URL"
            
            # å¾ªç¯æ£€æŸ¥å¯é€‰å˜é‡ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åŠ å…¥åˆ—è¡¨
            if [ -n "$EPG_URL_BACKUP" ]; then echo "EPG_URL_BACKUP"; fi
            if [ -n "$CACHE_TTL" ]; then echo "CACHE_TTL"; fi
            if [ -n "$FETCH_TIMEOUT" ]; then echo "FETCH_TIMEOUT"; fi
            if [ -n "$MAX_MEMORY_CACHE_CHARS" ]; then echo "MAX_MEMORY_CACHE_CHARS"; fi
            if [ -n "$MAX_SOURCE_SIZE_BYTES" ]; then echo "MAX_SOURCE_SIZE_BYTES"; fi
            if [ -n "$ERROR_COOLDOWN_MS" ]; then echo "ERROR_COOLDOWN_MS"; fi
            
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # ç¬¬ä¸ƒæ­¥ï¼šéƒ¨ç½²åˆ° Cloudflare Workers
      # é€»è¾‘åˆ¤æ–­ï¼šä»…åœ¨ Cloudflare å¯†é’¥ (Step 4) å’Œ EPG_URL (Step 5) åŒæ—¶å­˜åœ¨æ—¶æ‰§è¡Œ
      - name: Deploy to Cloudflare
        if: env.has_cf_creds == 'true' && env.has_epg == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          # ä½¿ç”¨ä¸Šä¸€æ­¥åŠ¨æ€ç”Ÿæˆçš„åˆ—è¡¨
          secrets: ${{ steps.secret_gen.outputs.list }}
        env:
          # å¿…é¡»åœ¨æ­¤å¤„å†æ¬¡æ˜ å°„æ‰€æœ‰å¯èƒ½çš„ Secretsï¼Œwrangler æ‰èƒ½çœŸæ­£è¯»å–åˆ°å€¼
          EPG_URL: ${{ secrets.EPG_URL }}
          EPG_URL_BACKUP: ${{ secrets.EPG_URL_BACKUP }}
          CACHE_TTL: ${{ secrets.CACHE_TTL }}
          FETCH_TIMEOUT: ${{ secrets.FETCH_TIMEOUT }}
          MAX_MEMORY_CACHE_CHARS: ${{ secrets.MAX_MEMORY_CACHE_CHARS }}
          MAX_SOURCE_SIZE_BYTES: ${{ secrets.MAX_SOURCE_SIZE_BYTES }}
          ERROR_COOLDOWN_MS: ${{ secrets.ERROR_COOLDOWN_MS }}